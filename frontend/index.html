<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSB System - Demo Simulator</title>
    
    <!-- Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4f46e5; --primary-hover: #4338ca;
            --success: #10b981; --success-hover: #059669;
            --danger: #ef4444; --danger-hover: #dc2626;
            --warning: #f59e0b; --info: #3b82f6;
            --bg: #f8fafc; --card: #ffffff; --text: #334155; --border: #e2e8f0;
        }

        body {
            font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text);
            margin: 0; padding: 20px; height: 100vh; box-sizing: border-box;
            display: flex; flex-direction: column;
        }

        /* HEADER */
        .header-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; background: white; padding: 15px 25px;
            border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }
        .brand { font-size: 1.5rem; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }
        .brand span { color: var(--text); font-weight: 400; font-size: 1rem; }
        .server-status { font-size: 0.85rem; font-weight: 600; padding: 6px 12px; border-radius: 20px; background: #fee2e2; color: var(--danger); }
        .server-status.connected { background: #dcfce7; color: #166534; }

        /* MAIN LAYOUT */
        .container { display: flex; gap: 20px; flex: 1; overflow: hidden; }

        .panel {
            flex: 1; background: var(--card); border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            border: 1px solid var(--border);
            display: flex; flex-direction: column; overflow: hidden;
        }

        .panel-head {
            padding: 15px 20px; background: #f1f5f9; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .panel-head h2 { margin: 0; font-size: 1.1rem; color: #0f172a; display: flex; align-items: center; gap: 8px; }

        .panel-body { padding: 20px; overflow-y: auto; flex: 1; }

        /* CONTROLS */
        .control-box {
            background: #fff; border: 1px solid var(--border);
            padding: 15px; border-radius: 10px; margin-bottom: 15px;
        }
        .label { font-size: 0.75rem; text-transform: uppercase; color: #64748b; font-weight: 700; margin-bottom: 8px; display: block; }
        
        select, input {
            width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;
            font-size: 0.9rem; outline: none; margin-bottom: 10px;
            background-image: linear-gradient(to bottom, #ffffff, #f8fafc);
        }

        /* BUTTONS */
        .btn-group { display: flex; gap: 10px; }
        button {
            flex: 1; padding: 12px; border: none; border-radius: 8px;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
            font-size: 0.9rem; display: flex; justify-content: center; align-items: center; gap: 6px;
            color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        button:active { transform: translateY(0); }

        .btn-primary { background: var(--primary); } .btn-primary:hover { background: var(--primary-hover); }
        .btn-success { background: var(--success); } .btn-success:hover { background: var(--success-hover); }
        .btn-danger { background: var(--danger); } .btn-danger:hover { background: var(--danger-hover); }
        .btn-warning { background: var(--warning); } .btn-warning:hover { background: #d97706; }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--text); } 
        .btn-outline:hover { background: #f1f5f9; }

        /* SIMULATION ELEMENTS */
        #map { height: 250px; width: 100%; border-radius: 8px; border: 1px solid var(--border); margin-top: 10px; }

        /* LOGS */
        .log-window {
            background: #1e293b; color: #10b981; padding: 15px;
            border-radius: 8px; font-family: 'Consolas', monospace; font-size: 0.8rem;
            height: 150px; overflow-y: auto; border: 1px solid #334155;
        }
        .log-line { margin-bottom: 4px; border-bottom: 1px solid #334155; padding-bottom: 2px; }
        .log-time { color: #64748b; margin-right: 8px; }
        .log-err { color: #ef4444; } .log-warn { color: #fbbf24; } .log-sys { color: #38bdf8; }

        /* ATTENDANCE LIST */
        .student-list { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        .student-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: #f8fafc;
        }
        .student-info b { display: block; font-size: 0.9rem; }
        .student-info span { font-size: 0.8rem; color: #64748b; }
        .student-actions button { padding: 6px 10px; font-size: 0.8rem; width: auto; }

        /* NOTIFICATIONS */
        .noti-list { height: 180px; overflow-y: auto; }
        .noti-card {
            padding: 12px; margin-bottom: 10px; background: white;
            border-left: 4px solid var(--primary); border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body>

    <div class="header-bar">
        <div class="brand">üöç SSB SIMULATOR <span> | Tr√¨nh gi·∫£ l·∫≠p H·ªá th·ªëng</span></div>
        <div id="server-status" class="server-status">Connecting...</div>
    </div>

    <div class="container">
        
        <!-- PANEL 1: T√ÄI X·∫æ -->
        <div class="panel">
            <div class="panel-head">
                <h2>üëÆ Giao di·ªán T√†i x·∫ø</h2>
                <div style="font-size: 12px; color: #64748b">Driver App</div>
            </div>
            <div class="panel-body">
                
                <!-- 1. K·∫øt n·ªëi -->
                <div class="control-box">
                    <span class="label">1. C·∫•u h√¨nh Chuy·∫øn ƒëi</span>
                    <div style="display:flex; gap:10px;">
                        <select id="tripSelect">
                            <option value="1">Tuy·∫øn 01: Trung t√¢m - LHP (Xe 59B-123.45)</option>
                            <option value="2">Tuy·∫øn 02: T√¢n B√¨nh (Xe 59B-999.99)</option>
                            <option value="15">Tuy·∫øn Demo</option>
                        </select>
                        <button class="btn-primary" onclick="joinTripDriver()" style="flex: 0.4;">K·∫øt n·ªëi</button>
                    </div>
                </div>

                <!-- 2. L√°i xe -->
                <div class="control-box">
                    <span class="label">2. M√¥ ph·ªèng L√°i xe (GPS)</span>
                    <button class="btn-success" id="btn-drive" onclick="toggleDrive()">‚ñ∂Ô∏è B·∫ÆT ƒê·∫¶U CH·∫†Y</button>
                    <div id="drive-status" style="text-align: center; font-size: 0.8rem; color: #64748b; margin-top: 5px;">Xe ƒëang d·ª´ng t·∫°i b·∫øn</div>
                </div>

                <!-- 3. ƒêi·ªÉm danh (M·ªöI) -->
                <div class="control-box">
                    <span class="label">3. ƒêi·ªÉm danh H·ªçc sinh (Test API)</span>
                    <div class="student-list">
                        <div class="student-item">
                            <div class="student-info"><b>Nguy·ªÖn B√© Bi</b><span>Tr·∫°m: Co.op Mart</span></div>
                            <div class="student-actions btn-group">
                                <button class="btn-outline" onclick="simulateAttendance(1, 'picked_up')" style="color:green; border-color:green">ƒê√≥n</button>
                                <button class="btn-outline" onclick="simulateAttendance(1, 'dropped_off')" style="color:blue; border-color:blue">Tr·∫£</button>
                            </div>
                        </div>
                        <div class="student-item">
                            <div class="student-info"><b>Tr·∫ßn B√© Bo</b><span>Tr·∫°m: CV 23/9</span></div>
                            <div class="student-actions btn-group">
                                <button class="btn-outline" onclick="simulateAttendance(2, 'picked_up')" style="color:green; border-color:green">ƒê√≥n</button>
                                <button class="btn-outline" onclick="simulateAttendance(2, 'dropped_off')" style="color:blue; border-color:blue">Tr·∫£</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. S·ª± c·ªë -->
                <div class="control-box" style="border-color: #fecaca; background: #fef2f2;">
                    <span class="label" style="color: #ef4444;">4. B√°o c√°o Kh·∫©n c·∫•p</span>
                    <div class="btn-group">
                        <button class="btn-warning" onclick="reportIncident('traffic')">üöó K·∫πt xe</button>
                        <button class="btn-danger" onclick="reportIncident('breakdown')">üõ†Ô∏è H·ªèng xe</button>
                    </div>
                </div>

                <span class="label">Console Log:</span>
                <div id="driver-log" class="log-window">
                    <div class="log-line">System ready...</div>
                </div>
            </div>
        </div>

        <!-- PANEL 2: PH·ª§ HUYNH -->
        <div class="panel">
            <div class="panel-head">
                <h2>üë®‚Äçüë©‚Äçüëß Giao di·ªán Ph·ª• huynh</h2>
                <div style="font-size: 12px; color: #64748b">Parent App</div>
            </div>
            <div class="panel-body">
                
                <div class="control-box">
                    <span class="label">Ch·ªçn ng·ªØ c·∫£nh theo d√µi</span>
                    <div style="display:flex; gap:10px; margin-bottom: 10px;">
                        <select id="parentSelect">
                            <option value="3">M·∫π B√© Bi (ID: 3)</option>
                            <option value="4">B·ªë B√© Bo (ID: 4)</option>
                        </select>
                        <select id="scheduleSelect">
                            <option value="1">Theo d√µi Tuy·∫øn 01</option>
                            <option value="2">Theo d√µi Tuy·∫øn 02</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="joinParent()">üì° B·∫ÆT ƒê·∫¶U THEO D√ïI</button>
                </div>

                <!-- Map -->
                <div id="map"></div>
                
                <div style="margin-top: 20px;">
                    <span class="label">üîî Trung t√¢m Th√¥ng b√°o (Real-time)</span>
                    <div id="noti-box" class="noti-list">
                        <div style="text-align: center; color: #94a3b8; margin-top: 20px;">Ch∆∞a c√≥ th√¥ng b√°o m·ªõi</div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // C·∫§U H√åNH
        const SOCKET_URL = "http://localhost:3000";
        const API_URL = "http://localhost:3000/api"; // D√πng ƒë·ªÉ g·ªçi API ƒëi·ªÉm danh
        
        const socket = io(SOCKET_URL);
        let driveInterval = null;
        let isDriving = false;
        
        // T·ªça ƒë·ªô gi·∫£ l·∫≠p (Qu·∫≠n 1, TP.HCM)
        let currentLat = 10.762622;
        let currentLng = 106.660172;

        // --- MAP SETUP ---
        const map = L.map('map').setView([currentLat, currentLng], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' }).addTo(map);
        
        const busIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/3448/3448339.png',
            iconSize: [40, 40], iconAnchor: [20, 20]
        });
        let busMarker = L.marker([currentLat, currentLng], {icon: busIcon}).addTo(map);

        // --- SOCKET EVENTS ---
        socket.on("connect", () => {
            document.getElementById('server-status').innerText = "üü¢ Connected";
            document.getElementById('server-status').className = "server-status connected";
        });

        socket.on("disconnect", () => {
            document.getElementById('server-status').innerText = "üî¥ Disconnected";
            document.getElementById('server-status').className = "server-status";
        });

        // Nghe v·ªã tr√≠ xe
        socket.on("update_location", (data) => {
            const { lat, lng, speed } = data;
            busMarker.setLatLng([lat, lng]);
            map.panTo([lat, lng]);
            busMarker.bindPopup(`<b>Xe Bu√Ωt</b><br>T·ªëc ƒë·ªô: ${speed} km/h`).openPopup();
        });

        // Nghe th√¥ng b√°o
        socket.on("child_status_change", (data) => addNoti(data.message, data.status === 'picked_up' ? 'success' : 'info'));
        socket.on("incident_alert", (data) => {
            addNoti(`üö® ${data.message}`, 'error');
            alert(`C·∫¢NH B√ÅO: ${data.message}`);
        });
        socket.on("push_notification", (data) => addNoti(`üì© ${data.title}: ${data.message}`, 'warning'));

        // --- DRIVER ACTIONS ---
        function joinTripDriver() {
            const id = document.getElementById("tripSelect").value;
            socket.emit("join_trip", { schedule_id: id });
            addLog(`T√†i x·∫ø joined Room: trip_${id}`, 'sys');
        }

        function toggleDrive() {
            const id = document.getElementById("tripSelect").value;
            const btn = document.getElementById("btn-drive");
            const status = document.getElementById("drive-status");

            if (isDriving) {
                clearInterval(driveInterval);
                isDriving = false;
                btn.innerHTML = "‚ñ∂Ô∏è B·∫ÆT ƒê·∫¶U CH·∫†Y";
                btn.className = "btn-success";
                status.innerText = "Xe ƒëang d·ª´ng t·∫°i b·∫øn";
                addLog("ƒê√£ t·∫Øt m√°y xe.", 'warn');
            } else {
                isDriving = true;
                btn.innerHTML = "üõë D·ª™NG XE";
                btn.className = "btn-danger";
                status.innerText = "üì° ƒêang di chuy·ªÉn & G·ª≠i t·ªça ƒë·ªô...";
                addLog("B·∫Øt ƒë·∫ßu l·ªô tr√¨nh...", 'info');

                driveInterval = setInterval(() => {
                    // Gi·∫£ l·∫≠p di chuy·ªÉn
                    currentLat += (Math.random() - 0.3) * 0.0005; 
                    currentLng += (Math.random() - 0.3) * 0.0005;

                    socket.emit("driver_send_location", {
                        schedule_id: id, lat: currentLat, lng: currentLng,
                        speed: Math.floor(Math.random() * 30) + 20
                    });
                    addLog(`GPS Sent: [${currentLat.toFixed(5)}, ${currentLng.toFixed(5)}]`);
                }, 2000);
            }
        }

        // Gi·∫£ l·∫≠p g·ªçi API ƒêi·ªÉm danh (C·∫ßn Token th·∫≠t m·ªõi g·ªçi ƒë∆∞·ª£c API, ·ªü ƒë√¢y ta gi·∫£ l·∫≠p b·∫±ng Socket emit ƒë·ªÉ test UI)
        // Trong th·ª±c t·∫ø App s·∫Ω g·ªçi axios.put(...)
        function simulateAttendance(studentId, status) {
            const scheduleId = document.getElementById("tripSelect").value;
            const studentName = studentId === 1 ? "Nguy·ªÖn B√© Bi" : "Tr·∫ßn B√© Bo";
            const msg = status === 'picked_up' ? `ƒê√£ ƒë√≥n b√© ${studentName} l√™n xe` : `ƒê√£ tr·∫£ b√© ${studentName} an to√†n`;
            
            // Emit socket gi·∫£ l·∫≠p s·ª± ki·ªán server b·∫Øn v·ªÅ (v√¨ ta kh√¥ng login ·ªü ƒë√¢y)
            // L∆ØU √ù: ƒê·ªÉ test chu·∫©n nh·∫•t, h√£y d√πng Postman g·ªçi API th·∫≠t. ·ªû ƒë√¢y ch·ªâ demo visual.
            addLog(`[ACTION] ${msg}`, 'info');
            
            // Gi·∫£ v·ªù Server b·∫Øn th√¥ng b√°o cho ph·ª• huynh
            // (Trong th·ª±c t·∫ø Backend s·∫Ω l√†m vi·ªác n√†y sau khi update DB)
            socket.emit("debug_fake_notification", {
                student_id: studentId,
                message: msg,
                status: status
            });
            // *L∆∞u √Ω: C·∫ßn s·ª≠a backend ƒë·ªÉ handle event debug n√†y n·∫øu mu·ªën test kh√¥ng c·∫ßn DB*
            // HO·∫∂C: B·∫°n ch·ªâ c·∫ßn nh√¨n log ·ªü ƒë√¢y l√† bi·∫øt n√∫t b·∫•m ho·∫°t ƒë·ªông.
        }

        function reportIncident(type) {
            const id = document.getElementById("tripSelect").value;
            socket.emit("driver_report_incident", {
                schedule_id: id,
                type: type,
                description: "S·ª± c·ªë ƒë∆∞·ª£c b√°o c√°o t·ª´ Simulator"
            });
            addLog(`‚ö†Ô∏è B√°o c√°o s·ª± c·ªë: ${type}`, 'err');
        }

        // --- PARENT ACTIONS ---
        function joinParent() {
            const scheduleId = document.getElementById("scheduleSelect").value;
            const parentId = document.getElementById("parentSelect").value;
            
            socket.emit("join_trip", { schedule_id: scheduleId });
            socket.emit("join_room_parent", { parent_id: parentId });
            
            document.getElementById("noti-box").innerHTML = "";
            addNoti(`ƒê√£ k·∫øt n·ªëi theo d√µi chuy·∫øn ${scheduleId}`, 'sys');
        }

        // --- UTILS ---
        function addLog(msg, type = '') {
            const box = document.getElementById("driver-log");
            const time = new Date().toLocaleTimeString();
            const colorClass = type === 'err' ? 'log-err' : (type === 'warn' ? 'log-warn' : (type === 'sys' ? 'log-sys' : ''));
            box.innerHTML = `<div class="log-line ${colorClass}"><span class="log-time">${time}</span>${msg}</div>` + box.innerHTML;
        }

        function addNoti(msg, type = 'info') {
            const box = document.getElementById("noti-box");
            if(box.innerHTML.includes("Ch∆∞a c√≥ th√¥ng b√°o")) box.innerHTML = "";
            
            const color = type === 'success' ? '#10b981' : (type === 'error' ? '#ef4444' : '#3b82f6');
            const bg = type === 'error' ? '#fef2f2' : 'white';
            
            box.innerHTML = `
                <div class="noti-card" style="border-left-color: ${color}; background: ${bg}">
                    <div style="font-weight:bold; font-size:0.8rem; color:#94a3b8">${new Date().toLocaleTimeString()}</div>
                    <div style="color:#334155">${msg}</div>
                </div>
            ` + box.innerHTML;
        }
    </script>
</body>
</html>