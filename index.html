<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SSB Tracking & Attendance Test</title>
    <!-- Th∆∞ vi·ªán B·∫£n ƒë·ªì Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Th∆∞ vi·ªán Socket Client -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; gap: 20px; padding: 20px; background-color: #f4f4f9; }
        .box { 
            background: white; 
            border: 1px solid #ddd; 
            padding: 20px; 
            width: 45%; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h2 { margin-top: 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        /* Ch·ªânh k√≠ch th∆∞·ªõc b·∫£n ƒë·ªì */
        #map { height: 350px; width: 100%; border-radius: 8px; margin-top: 15px; border: 1px solid #ccc;}
        
        /* Khu v·ª±c log th√¥ng b√°o */
        #logs { 
            height: 150px; 
            overflow-y: auto; 
            background: #fff3cd; 
            border: 1px solid #ffeeba; 
            padding: 10px; 
            margin-top: 10px; 
            border-radius: 5px; 
            font-size: 14px;
        }

        .status { font-weight: bold; color: green; }
        
        button { 
            padding: 10px 15px; cursor: pointer; color: white; border: none; border-radius: 6px; font-weight: bold; margin-top: 5px;
        }
        .btn-blue { background: #007bff; }
        .btn-blue:hover { background: #0056b3; }
        .btn-orange { background: #fd7e14; }
        .btn-orange:hover { background: #e36209; }
        .btn-green { background: #28a745; }
        
        input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 60px; text-align: center; }
        label { font-weight: 500; }
    </style>
</head>
<body>

    <!-- KHUNG T√ÄI X·∫æ -->
    <div class="box">
        <h2>üöó App T√†i X·∫ø (Gi·∫£ l·∫≠p)</h2>
        <p>K·∫øt n·ªëi: <span id="driver-status" style="color:red">ƒêang k·∫øt n·ªëi...</span></p>
        
        <div style="background: #e9ecef; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
            <label>ID Chuy·∫øn:</label>
            <input type="number" id="tripId" value="1">
            <button class="btn-blue" onclick="joinTripDriver()">1. V√†o Chuy·∫øn Xe</button>
        </div>
        
        <div style="background: #fff3cd; padding: 10px; border-radius: 8px;">
            <button class="btn-orange" onclick="startMoving()">2. B·∫Øt ƒë·∫ßu l√°i xe (Auto)</button>
            <p style="font-size: 13px; color: #666; margin-bottom: 0;"><i>(Xe s·∫Ω t·ª± ƒë·ªông ch·∫°y v√† g·ª≠i t·ªça ƒë·ªô m·ªói 2 gi√¢y)</i></p>
            <div id="driver-log" style="font-family: monospace; margin-top: 5px; color: #333;">...</div>
        </div>
    </div>

    <!-- KHUNG PH·ª§ HUYNH -->
    <div class="box" style="width: 50%;">
        <h2>üë®‚Äçüë©‚Äçüëß App Ph·ª• Huynh</h2>
        <p>Tr·∫°ng th√°i: <span id="parent-status">Ch∆∞a theo d√µi</span></p>
        
        <!-- Ph·∫ßn theo d√µi b·∫£n ƒë·ªì -->
        <div style="margin-bottom: 15px;">
            <label>Xem chuy·∫øn:</label>
            <input type="number" id="scheduleId" value="1">
            <button class="btn-blue" onclick="joinTripParent()">Xem B·∫£n ƒê·ªì</button>
        </div>

        <!-- Ph·∫ßn nh·∫≠n th√¥ng b√°o ƒëi·ªÉm danh -->
        <div style="border-top: 1px dashed #ccc; padding-top: 10px;">
            <label>B·∫°n l√† Ph·ª• Huynh ID:</label>
            <input type="number" id="parentId" value="4" style="background: #e8f0fe;">
            <button class="btn-green" onclick="joinParentRoom()">Nh·∫≠n th√¥ng b√°o</button>
            <small>(M·∫∑c ƒë·ªãnh ID 4 l√† ph·ª• huynh c·ªßa b√© ID 1)</small>
        </div>

        <!-- B·∫£n ƒë·ªì -->
        <div id="map"></div>

        <!-- Log th√¥ng b√°o -->
        <h4>üîî Th√¥ng b√°o ƒêi·ªÉm danh:</h4>
        <div id="logs">
            <div style="color: #999; font-style: italic;">Ch∆∞a c√≥ th√¥ng b√°o m·ªõi...</div>
        </div>
    </div>

    <script>
        // K·∫øt n·ªëi Socket
        const socket = io("http://localhost:3000");
        let timer = null;

        // ===========================================
        // 1. C·∫§U H√åNH B·∫¢N ƒê·ªí
        // ===========================================
        const map = L.map('map').setView([10.762622, 106.660172], 15);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'OpenStreetMap'
        }).addTo(map);

        const busIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/3448/3448339.png',
            iconSize: [40, 40],
            iconAnchor: [20, 20],
        });
        let busMarker = L.marker([10.762622, 106.660172], {icon: busIcon}).addTo(map);

        // ===========================================
        // 2. LOGIC SOCKET
        // ===========================================
        socket.on("connect", () => {
            document.getElementById("driver-status").innerText = "Online ‚úÖ";
            document.getElementById("driver-status").style.color = "green";
        });

        // --- T√ÄI X·∫æ ---
        function joinTripDriver() {
            const id = document.getElementById("tripId").value;
            socket.emit("join_trip", { schedule_id: id });
            alert(`T√†i x·∫ø ƒë√£ v√†o chuy·∫øn s·ªë ${id}`);
        }

        function startMoving() {
            const id = document.getElementById("tripId").value;
            let lat = 10.762622;
            let lng = 106.660172;

            if (timer) clearInterval(timer);
            
            timer = setInterval(() => {
                lat += 0.0001; 
                lng += 0.0001;

                socket.emit("driver_send_location", {
                    schedule_id: id,
                    lat: lat,
                    lng: lng,
                    speed: 30
                });
                
                document.getElementById("driver-log").innerText = `ƒêang g·ª≠i: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
            }, 2000);
        }

        // --- PH·ª§ HUYNH (MAP) ---
        function joinTripParent() {
            const id = document.getElementById("scheduleId").value;
            socket.emit("join_trip", { schedule_id: id });
            document.getElementById("parent-status").innerText = `ƒêang xem chuy·∫øn ${id}`;
        }

        socket.on("update_location", (data) => {
            const { lat, lng } = data;
            busMarker.setLatLng([lat, lng]);
            map.panTo([lat, lng]); 
        });

        // --- PH·ª§ HUYNH (TH√îNG B√ÅO ƒêI·ªÇM DANH) ---
        function joinParentRoom() {
            const pid = document.getElementById("parentId").value;
            // G·ª≠i event ƒë·ªÉ server bi·∫øt ƒë√¢y l√† Ph·ª• huynh s·ªë m·∫•y
            socket.emit("join_room_parent", { parent_id: pid });
            alert(`ƒê√£ ƒëƒÉng nh·∫≠p Ph·ª• huynh ID ${pid}. ƒêang ch·ªù tin nh·∫Øn...`);
        }

        // L·∫Øng nghe s·ª± ki·ªán t·ª´ Server (Tracking Controller b·∫Øn sang)
        socket.on("child_status_change", (data) => {
            const logBox = document.getElementById("logs");
            
            // X√≥a d√≤ng "Ch∆∞a c√≥ th√¥ng b√°o" n·∫øu c√≥
            if(logBox.innerHTML.includes("Ch∆∞a c√≥ th√¥ng b√°o")) logBox.innerHTML = "";

            const time = new Date(data.time).toLocaleTimeString();
            const color = data.status === 'picked_up' ? 'green' : 'blue';
            
            // Th√™m th√¥ng b√°o m·ªõi v√†o ƒë·∫ßu danh s√°ch
            logBox.innerHTML = `
                <div style="border-bottom: 1px solid #ddd; padding: 5px 0;">
                    <strong style="color:${color}">[${time}]</strong> ${data.message}
                </div>
            ` + logBox.innerHTML;
        });

    </script>
</body>
</html>